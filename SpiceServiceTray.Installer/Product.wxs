<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" Name="SpiceService Tray Application" Language="1033" Version="!(bind.FileVersion.SpiceServiceTray.exe)" Manufacturer="SpiceService" UpgradeCode="a1b2c3d4-e5f6-7890-abcd-ef1234567890">
    <Package InstallerVersion="500" Compressed="yes" InstallScope="perUser" Description="SpiceService Tray Application - Circuit Simulation API" />
    
    <!-- InstallScope="perUser" ensures per-user installation (no admin required) -->
    
    <Property Id="ARPCOMMENTS">Copyright (c) 2025 Keith Rule. Free for personal use. Commercial license required for commercial use.</Property>
    <Property Id="ARPHELPLINK">https://github.com/SpiceSharp/SpiceSharp</Property>

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <!-- Install to user's LocalAppData (no admin required) -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="LocalAppDataFolder">
        <Directory Id="INSTALLFOLDER" Name="SpiceService">
          <Directory Id="TrayAppFolder" Name="Tray">
            <Directory Id="LibrariesFolder" Name="libraries" />
          </Directory>
        </Directory>
      </Directory>
      <!-- User-specific folders (automatically per-user with InstallScope="perUser") -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="SpiceService" />
      </Directory>
      <Directory Id="DesktopFolder" Name="Desktop" />
      <Directory Id="StartupFolder" Name="Startup" />
    </Directory>

    <!-- Application Files -->
    <ComponentGroup Id="ProductComponents" Directory="TrayAppFolder">
      <Component Id="TrayAppFolderComponent" Guid="b2c3d4e5-f6a7-8901-bcde-f12345678901">
        <CreateFolder />
        <RemoveFolder Id="RemoveTrayAppFolder" Directory="TrayAppFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\SpiceService\Tray" Name="InstallPath" Type="string" Value="[TrayAppFolder]" KeyPath="yes" />
      </Component>
      
      <!-- Main executable and DLL - manually defined for reliable shortcut reference -->
      <Component Id="TrayAppExecutable" Guid="e5f6a7b8-c9d0-1234-efab-345678901234">
        <File Id="SpiceServiceTray.exe" 
              Source="$(var.TrayAppSourceDir)\SpiceServiceTray.exe" 
              KeyPath="yes" />
        <File Id="SpiceServiceTray.dll" 
              Source="$(var.TrayAppSourceDir)\SpiceServiceTray.dll" />
      </Component>
      
      <!-- McpRemote.exe proxy executable - must be colocated with tray app -->
      <Component Id="McpRemoteExecutable" Guid="f6a7b8c9-d0e1-2345-fabc-456789012345">
        <File Id="McpRemote.exe" 
              Source="$(var.McpRemoteSourceDir)\McpRemote.exe" 
              KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Component Libraries -->
    <!-- Note: Library files are harvested by Heat during build and included via HarvestedLibraries.wxs -->
    <ComponentGroup Id="LibraryComponents" Directory="LibrariesFolder">
      <Component Id="LibrariesFolderComponent" Guid="a1b2c3d4-e5f6-7890-abcd-ef1234567891">
        <CreateFolder />
        <RemoveFolder Id="RemoveLibrariesFolder" Directory="LibrariesFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\SpiceService\Tray" Name="LibrariesPath" Type="string" Value="[LibrariesFolder]" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Harvested files from build output (dependencies, config files, etc.) -->
    <!-- Note: HarvestedFiles.wxs is generated by Heat during build and included automatically -->
    <!-- Heat will exclude the main exe since we define it manually above -->
    
    <!-- Harvested library files from libraries directory -->
    <!-- Note: HarvestedLibraries.wxs is generated by Heat during build and included automatically -->

    <!-- Main Feature -->
    <Feature Id="ProductFeature" Title="SpiceService Tray" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="HarvestedFiles" />
      <ComponentGroupRef Id="LibraryComponents" />
      <ComponentGroupRef Id="HarvestedLibraries" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="DesktopShortcut" />
      <ComponentRef Id="StartupShortcut" />
      <ComponentRef Id="UninstallShortcut" />
    </Feature>

    <!-- Start Menu Shortcut (user-specific) -->
    <Component Id="ApplicationShortcut" Directory="ApplicationProgramsFolder" Guid="c3d4e5f6-a7b8-9012-cdef-123456789012">
      <Shortcut Id="ApplicationStartMenuShortcut" 
                Name="SpiceService Tray" 
                Description="SpiceService Circuit Simulation Tray Application" 
                Target="[#SpiceServiceTray.exe]" 
                WorkingDirectory="TrayAppFolder"
                Icon="ProductIcon" />
      <RemoveFolder Id="RemoveApplicationProgramsFolder" Directory="ApplicationProgramsFolder" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\SpiceService\Tray" Name="Installed" Type="integer" Value="1" KeyPath="yes" />
    </Component>

    <!-- Desktop Shortcut -->
    <Component Id="DesktopShortcut" Directory="DesktopFolder" Guid="e6f7a8b9-c0d1-2345-efab-456789012345">
      <Shortcut Id="DesktopShortcut" 
                Name="SpiceService Tray" 
                Description="SpiceService Circuit Simulation Tray Application" 
                Target="[#SpiceServiceTray.exe]" 
                WorkingDirectory="TrayAppFolder"
                Icon="ProductIcon" />
      <RemoveFolder Id="RemoveDesktopShortcut" Directory="DesktopFolder" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\SpiceService\Tray" Name="DesktopShortcut" Type="integer" Value="1" KeyPath="yes" />
    </Component>

    <!-- Startup Shortcut (auto-start on login) -->
    <Component Id="StartupShortcut" Directory="StartupFolder" Guid="f7a8b9c0-d1e2-3456-fabc-567890123456">
      <Shortcut Id="StartupShortcut" 
                Name="SpiceService Tray" 
                Description="SpiceService Circuit Simulation Tray Application" 
                Target="[#SpiceServiceTray.exe]" 
                WorkingDirectory="TrayAppFolder"
                Icon="ProductIcon" />
      <RemoveFolder Id="RemoveStartupShortcut" Directory="StartupFolder" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\SpiceService\Tray" Name="StartupShortcut" Type="integer" Value="1" KeyPath="yes" />
    </Component>

    <!-- Uninstall Shortcut -->
    <Component Id="UninstallShortcut" Directory="ApplicationProgramsFolder" Guid="d4e5f6a7-b8c9-0123-def4-234567890123">
      <Shortcut Id="UninstallProduct" 
                Name="Uninstall SpiceService Tray" 
                Description="Uninstall SpiceService Tray Application" 
                Target="[SystemFolder]msiexec.exe" 
                Arguments="/x [ProductCode]" />
      <RemoveFolder Id="RemoveApplicationProgramsFolder2" Directory="ApplicationProgramsFolder" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\SpiceService\Tray" Name="UninstallShortcut" Type="integer" Value="1" KeyPath="yes" />
    </Component>

    <!-- Icon for installer and shortcuts -->
    <Icon Id="ProductIcon" SourceFile="$(var.IconPath)" />
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />

    <!-- Custom Actions -->
    <!-- Launch application after installation -->
    <CustomAction Id="LaunchApplication" 
                  Directory="TrayAppFolder"
                  ExeCommand="SpiceServiceTray.exe" 
                  Execute="immediate" 
                  Impersonate="yes" 
                  Return="asyncNoWait" />
    
    <!-- Install Execute Sequence -->
    <InstallExecuteSequence>
      <Custom Action="LaunchApplication" After="InstallFinalize">NOT Installed</Custom>
    </InstallExecuteSequence>

    <!-- UI -->
    <UIRef Id="WixUI_Minimal" />
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
  </Product>
</Wix>
